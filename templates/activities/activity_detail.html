{% extends 'base.html' %}

{% load static %}

{% block title %}{{ activity.name }}{% endblock title %}

{% block stylesheet %}
<link rel="stylesheet" type="text/css" href="{% static 'css/jssocials.css'%}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/jssocials-theme-flat.css'%}" />
<link rel="stylesheet" type="text/css" href="{% static 'css/slick.css'%}"/>
<link rel="stylesheet" type="text/css" href="{% static 'css/slick-theme.css'%}"/>
<!-- <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/jquery.jssocials/1.4.0/jssocials.css" /> -->
<!-- <link type="text/css" rel="stylesheet" href="https://cdn.jsdelivr.net/jquery.jssocials/1.4.0/jssocials-theme-flat.css" /> -->

<style>
  #map {
    height: 500px;
    width: 100%;
  }
  #fb_desktop {
    border-radius: 0%;
  }
  button {
    cursor: pointer;
  }
  .btn:focus,.btn:active {
    outline: none !important;
    box-shadow: none;
  }
  #id_others {
    background-color: rgb(233, 227, 227);
    padding-top: 0.5em;
    padding-bottom: 2em;
  }
  .btn.focus {
    outline-color: transparent;
  }
  .js-bookmark-article.active {
    background-color:rgb(92,184,92);
  }
  .js-bookmark-article {
    background: transparent;
    border-color: grey;
  }
  #edit_btn {
    background: lightgrey;
    color: grey;
    border-color: transparent;
  }
  tr:hover {
    background-color: white;
  }
  .tooltip-inner
  { background-color:red;}

  .tooltip.bs-tooltip-auto[x-placement^=left] .arrow::before, .tooltip.bs-tooltip-left .arrow::before 
  { border-left-color: red;}


</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
<div class="card" style="border:none;">
  <div class="row">
    <div class="col-md-8">
      {% if activity.activity_img %}
      <img class="card-img-top select" src="{{ activity.activity_img.url }}" 
      alt="Not Found" onerror="this.onerror=null;this.src='http://via.placeholder.com/770x560?text=Image not available';" 
      style="object-fit:cover;margin:auto;height:560px;display:inline;border-radius:2%;">
      {% else %}
      <img class="card-img-top select" src="http://via.placeholder.com/770x568?text=Image not available" 
      alt="Not Found" style="object-fit: cover;display:inline;margin:auto;height:560px;border-radius:2%;">
      {% endif %}
    </div>
    <div class="col-md-4">
      <h4 class="mt-5">{{ activity.name }}</h4>
      <p style="margin-top:38px;"><img src="http://via.placeholder.com/60x50?text=" alt="Not Found" height="50px" width="60px">&nbsp;&nbsp;&nbsp;
         By {{ activity.created_by.profile.organisation_name }}</p>

      <hr style="margin-bottom:38px;">

      <!-- LOCATION -->
      {% if activity.location %}
      <p class="card-text" id="address">{{ activity.location }}</p>
      <p class="card-text"><a href=# id="address2">Open in Google Maps</a></p>
      {% else %}
      <p class="card-text"><i>Location hasn't been specified</i></p>
      {% endif %}

      <!-- DATE AND TIME -->
      <!--    Activities that only occur once -->
      {% if activity.term == 'Once' %}
      {% if activity.activity_date %}
      <p class="card-text">{{ activity.activity_date|date:'D, d F Y' }} 
          {{ activity.start_time|time:'g:i A'|lower }} - {{ activity.end_time|time:'g:i A'|lower }}
      </p>
      {% endif %}
      {% endif %}
      <!--      Daily, weekly, fortnightly, monthly activities-->
      {% if activity.term != 'Once' %}
      {% if activity.term != 'Daily' %}
      <p class="card-text">Every {{ activity.activity_day }} from {{ activity.start_date|date:'D, d F Y' }} to {{ activity.end_date|date:'D, d F Y' }} 
          {{ activity.start_time|time:'g:i A'|lower }} - {{ activity.end_time|time:'g:i A'|lower }}
      </p>
      {% else %}
      <p class="card-text">Every day from {{ activity.start_date|date:'D, d M Y' }} to {{ activity.end_date|date:'D, d F Y' }} 
          {{ activity.start_time|time:'g:i A'|lower }} - {{ activity.end_time|time:'g:i A'|lower }}
      </p>
      {% endif %}
      {% endif %}

      <hr style="margin-bottom:35px;margin-top:35px;">

      <h6 class="card-title">Contact Organiser</h6>
      {% if activity.organiser %}
      <p class="card-text">{{ activity.organiser }} {{ activity.contact_number }}</p>
      {% else %}
      <p class="card-text small"><i>Organiser contact hasn't been specified</i></p>
      {% endif %}

      {% if activity.cost_choice == 'N' %}
        <h6 class="strong mt-5">FREE!</h6>
      {% endif %}
      {% if activity.cost_choice == 'Y' %}
        <h6 class="strong mt-5">AUD {{ activity.cost }}</h6>
      {% endif %}
    </div>
  </div>

  <div class="row justify-content-center mt-4">
    <div class="col-sm-2 col-6 justify-content-center mb-4" style="padding-left:0;">
      {% if activity.created_by == user %}
      <a href="#collapseExample" data-toggle="collapse" role="button" aria-expanded="false" 
      aria-controls="collapseExample" class="btn" style="color:#000000;">
      <img src="{% static 'img/icons/people.svg' %}" height="45">&nbsp;&nbsp;
      <img src="{% static 'img/icons/down-arrow.svg' %}" height="25">
      <!-- <span id="attendees_no"> {{ attendees_no }}</span>  -->
      &nbsp;Attendees</a>
      <div class="collapse bg-light" id="collapseExample" style="z-index:1;position:absolute;">
        <div class="mt-2 mb-2" style="overflow-x:auto;">
          <table class="table" id="contact-table">
          {% include 'booking/includes/partial_attendee_list.html' %}
          </table>
        </div>
      </div>
      {% endif %}
    </div>
    <div class="col-6 col-sm-2 mb-4">
      <div class="row justify-content-center">
      <a href="#" class="btn js-share-url">
      <img src="{% static 'img/icons/share.svg' %}" height="45"></a>
      <a href="#" class="btn js-share-url" style="color:#000000;margin-left:-5px;margin-top:10px;">Share</a>
      {% if user.is_authenticated %}
      <!-- <a href="{% url 'sms_create' activity.pk %}" target="_blank" class="btn btn-outline-primary mt-1 mr-1"><i class="fas fa-mobile-alt"></i> SMS</a>
      <a href="{% url 'email_create' activity.pk %}" target="_blank" class="btn btn-outline-primary mt-1 mr-1"><i class="far fa-envelope"></i> Email</a> -->
      {% endif %}
      </div>
    </div>
    <div class="col-6 col-sm-2 mb-2">
      <div class="row justify-content-center">
      {% if activity.created_by == user and attendees_no > 0 %}
      <img src="{% static 'img/icons/checklist.svg' %}" height="45">
      <a href="{% url 'print_attendee_list' activity.pk %}" class="btn" style="color:#000000;">
      Print Attendees<br />List</a>
      {% else %}
      <img src="{% static 'img/icons/checklist.svg' %}" height="45">
      <a href="#" class="btn disabled" style="color:#000000;">
      Print Attendees<br />List</a>
      {% endif %}
      </div>
    </div>
    <div class="col-6 col-sm-2 mb-2">
      <div class="row justify-content-center">
      <img src="{% static 'img/icons/advertising.svg' %}" height="45">
      {% if activity.flyer %}
      <a href="{{ activity.flyer.url }}" class="btn" style="color:#000000;">
      Print Activity <br/> Flyer</a>
      {% endif %}
      {% if not activity.flyer %}
      <a href="#" class="btn disabled" style="color:#000000;">
      Print Activity <br/> Flyer</a>
      {% endif %}
      </div>
    </div>
    <div class="col-12 col-sm-4">
        {% if user.is_authenticated %}
        <button class="btn btn-lg btn-block disabled">I'M COMING!</button>
        {% else %}
        {% if available %}
        <a href="{% url 'register_activity' activity.pk %}" class="btn btn-success btn-lg btn-block mt-2" style="vertical-align:middle;display: inline-block;">I'M COMING!</a>
        {% else %}
        <button class="btn btn-lg btn-block disabled">Fully booked</button>
        {% endif %}
        {% endif %}
      </div>
  </div>
</div>
</div>

<div class="container-fluid" 
    style="padding-left:15px;margin-top:30px;background:#FAFAFA;
    padding-top:80px;padding-bottom:80px;">
  <div class="container">
  <div class="col-md-8">
  <h6 class="card-title">DESCRIPTION</h6>
  <p class="card-text" style="margin-bottom:5%;">{{ activity.description }}</p>
  <h6 class="card-title">ELIGIBILITY</h6>
  {% if activity.min_age and activity.max_age %}
    {{ activity.min_age }} to {{ activity.max_age }} years of age<br />
  {% endif %}

  {% if activity.max_age and not activity.min_age %}
    Maximum: {{ activity.max_age }} years old <br />
  {% endif %}

  {% if activity.min_age and not activity.max_age %}
    Minimum: {{ activity.min_age }} years old <br />
  {% endif %}

  {% if activity.background %} {{ activity.background }}<br />{% endif %}

  {% if activity.gender == 'B' %}Both females and males{% endif %}
  {% if activity.gender == 'F' %}Only females{% endif %}
  {% if activity.gender == 'M' %}Only males{% endif %}
  {% if activity.living_duration != 'Open' %}
  <p class="card-text" style="margin-bottom:5%;">Living in Australia for {{ activity.living_duration|lower }} than 5 years </p>      
  {% endif %}

  <h6 class="card-title mt-4">OTHER INFO</h6>
  <!--      Number of available spaces-->
  {% if activity.space_choice == 'Limited' %}
  <p class="card-text">Available space: <span id="available_space">{{ activity.space }}</span> people</p>
  {% endif %}
  <!--      Activity cost-->
  {% if activity.cost_choice == 'N' %}Free of charge
  {% else %}Cost: AUD {{ activity.cost }}{% endif %}
  
  <p class="card-text" style="text-align:right;">
  {% if user.is_authenticated %}
  {% if activity.created_by == user %}
  <a id="edit_btn_url" href="{% url 'edit_activity' activity.pk %}" 
  class="btn btn-success btn-lg mt-4" style="width:20%;">EDIT</a>
  {% else %}
  <a id="edit_btn" href="#" class="btn btn-success btn-lg mt-4" 
  data-toggle="tooltip" data-placement="left" title="Only modifiable by activity organiser">EDIT</a>
  {% endif %}
  {% endif %}
  </p>
</div>
</div>
</div>

<br />


{% if org_activities %}
<!-- More activities from the same organisation -->
<div class="container-fluid mt-4">
  <h3 style="margin-top:10%;margin-bottom:2%;">More activities and events from this organiser</h3>
  <div class="container-fluid mt-4">
    <div class="multiple-items">
      {% for org_activity in org_activities %}
      <div class="card mr-2">
        {% if org_activity.activity_img %}
        <img class="card-img-top" src="{{ org_activity.activity_img.url }}" alt="Not Found" onerror="this.onerror=null;this.src='http://via.placeholder.com/350x300?text=Image not available';" style="object-fit:cover;height:200px;display:inline;">
        {% else %}
        <img class="card-img-top" src="http://via.placeholder.com/350x200?text=Image not available" alt="Not Found" style="object-fit: cover;display:inline;margin:auto;height:200px;">
        {% endif %}
        <div class="card-body">
        <p class="lead"><a href="{% url 'activity_detail' org_activity.pk %}">{{ org_activity.name }}</a></p>
        {% if org_activity.location %}<p class="card-text"> {{ org_activity.location }} </p>{% endif %}
        <!--    Activities that only occur once -->
        {% if org_activity.term == 'Once' %}
        {% if org_activity.activity_date %}
        <p class="card-text">{{ org_activity.activity_date|date:'D, d M Y'|upper }} - {{ org_activity.start_time|time:'g:i A' }}</p>
        {% endif %}
        {% endif %}

        <!--      Daily, weekly, fortnightly, monthly activities-->
        {% if org_activity.term != 'Once' %}
        {% if org_activity.term != 'Daily' %}
        <p class="card-text">Every {{ org_activity.activity_day }} - {{ org_activity.start_time|time:'g:i A' }}</p>
        {% else %}
        <p class="card-text">Every day - {{ org_activity.start_time|time:'g:i A' }}</p>
        {% endif %}
        {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

<!-- Google Maps -->
{% if activity.location %}
<div class="container-fluid">
  <div class="row justify-content-center">
    <div id="map" style="margin-top:5%;"></div>
  </div>
</div>
{% endif %}

{% if recommended_activities %}
<!-- Other events and activities you may like -->
<div id="id_others" class="container-fluid mt-4 mb-0">
<h3 class="text-center" style="margin-top:2%;margin-bottom:2%;">Other events and activities you may like</h3>
<div class="container-fluid mt-4">
<div class="multiple-items">
  {% for recommended_activity in recommended_activities %}
  <div class="card mr-2">
    {% if recommended_activity.activity_img %}
    <img class="card-img-top" src="{{ recommended_activity.activity_img.url }}" alt="Not Found" onerror="this.onerror=null;this.src='http://via.placeholder.com/350x200?text=Image not available';" style="object-fit:cover;height:200px;display:inline;">
    {% else %}
    <img class="card-img-top" src="http://via.placeholder.com/350x300?text=Image not available" alt="Not Found" style="object-fit: cover;display:inline;margin:auto;height:200px;">
    {% endif %}
    <div class="card-body">
      <p class="lead"><a href="{% url 'activity_detail' recommended_activity.pk %}">{{ recommended_activity.name }}</a></p>
      {% if recommended_activity.location %}<p class="card-text"> {{ recommended_activity.location }} </p>{% endif %}
      
      <!--    Activities that only occur once -->
      {% if recommended_activity.term == 'Once' %}
      {% if recommended_activity.activity_date %}
      <p class="card-text">{{ recommended_activity.activity_date|date:'D, d M Y'|upper }} - {{ recommended_activity.start_time|time:'g:i A' }}</p>
      {% endif %}
      {% endif %}

      <!--      Daily, weekly, fortnightly, monthly activities-->
      {% if recommended_activity.term != 'Once' %}
      {% if recommended_activity.term != 'Daily' %}
      <p class="card-text">Every {{ recommended_activity.activity_day }} - {{ recommended_activity.start_time|time:'g:i A' }}</p>
      {% else %}
      <p class="card-text">Every day from {{ recommended_activity.start_date|date:'D, d M Y' }} - {{ recommended_activity.start_time|time:'g:i A' }}</p>
      {% endif %}
      {% endif %}
    </div>
  </div>
  {% endfor %}
</div>
</div>
</div>
{% endif %}

<!-- THE MODAL FOR SHARING URL -->
<div class="modal fade" id="modal-share-url">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Share the link</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <!-- <div id="div_desktop" class="row mt-2" style="align-content:center;">
        <div id="share2" class="offset-md-3 mr-2"></div>
        <div id="share3" class="float-left mr-2"></div>
        <div class="jssocials send_dialog float-left mr-2">
            <div class="jssocials-shares">
            <div class="jssocials-share jssocials-share-messenger2">
                <button type="button" onclick="sendDialog(this.id)" target="_self" id="id_send_dialog" class="btn btn-primary send_dialog2" style="width:50px; height:40px;"><i class="fab fa-facebook-messenger fa-lg"></i></button>
            </div>
            </div>
        </div>
        <div id="share4" class="mr-2 share4 float-left"></div>
        <div id="share5" class="mr-2 share5 float-left"></div>
        <div id="share" class="mr-2 share float-left"></div>
      </div> -->
    <div class="row justify-content-center mt-3">
        <div class="addthis_inline_share_toolbox"></div>
        <!-- <div class="sharethis-inline-share-buttons"></div> -->
    </div>
    <div class="row mt-2 ml-3 mr-1">
    <input style="width:85%;" class="form-control mr-2" readonly type="text" id="id_share_url" value="http://{{ domain }}{% url 'activity_detail' activity.pk %}">
    <button class="btn btn-outline-success" type="button" onclick="copyURL(this.id)" id="cpbtn"><i class="far fa-copy"></i></button>
    </div>
    <div class="row ml-3 mt-1">
    <p class="small" id="id_url_text"></p>
    </div>
    </div>
  </div>
</div>

<!-- Modal to register attendee -->
<div class="modal fade" id="modal-register">
  <div class="modal-dialog">
      <div class="modal-content"></div>
  </div>
</div>

{% endblock %}

{% block javascript %}
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDuR6-6PfCU7wRsSRRR3DH_PseEAYvyp3k&region=AU&callback=initMap">
</script>
<!-- <script type="text/javascript" src="//platform-api.sharethis.com/js/sharethis.js#property=5a2f1bb7fce9e20013a73372&product=inline-share-buttons"></script> -->

<!-- Go to www.addthis.com/dashboard to customize your tools -->
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5a435c987240088a"></script>
<script defer src="https://use.fontawesome.com/releases/v5.0.2/js/all.js"></script>

<script src="{% static 'js/jssocials.js' %}"></script>
<script src="{% static 'js/slick.js' %}"></script>

<script>
  // Show the map
  setTimeout(function initMap() {
    var geocoder = new google.maps.Geocoder();
    var map = new google.maps.Map(document.getElementById('map'));
    
    // Populate addresses from GMaps on address input
    var address = $('#address').text();
    geocodeAddress(geocoder, map);

    // Populate GMaps URL on the address link
    var map_url = "https://www.google.com/maps/search/?api=1&query=";
    var full_url = map_url + address;
    $("#address2").attr("href", full_url);
  }, 1000);

  function geocodeAddress(geocoder, resultsMap) {
    var address = $('#address').text();
    // var address = 'Southern Cross Station';
    // alert(address);
    geocoder.geocode({'address': address}, function(results, status) {
      if (status === 'OK') {
        resultsMap.setCenter(results[0].geometry.location);
        resultsMap.setZoom(14);
        var marker = new google.maps.Marker({
          map: resultsMap,
          position: results[0].geometry.location
        });
      }
    });
  }
  // google.maps.event.addDomListener(window, 'page:load', initMap);


  $("#share").jsSocials({
      shares: ["messenger"],
      showLabel: false,
      shareIn: "popup",
      url: window.location.hostname+"{% url 'activity_detail' activity.pk %}",
  });
  $("#share2").jsSocials({
      shares: ["facebook"],
      showLabel: false,
      shareIn: "popup",
  });
  $("#share3").jsSocials({
      shares: ["email"],
      showLabel: false,
      shareIn: "popup",
  });
  $("#share4").jsSocials({
      shares: ["whatsapp"],
      showLabel: false,
      shareIn: "popup",
  });
  $("#share5").jsSocials({
      shares: ["sms"],
      showLabel: false,
      shareIn: "popup",
  });

  window.fbAsyncInit = function() {
    FB.init({
      appId            : '1943348669252986',
      autoLogAppEvents : true,
      xfbml            : true,
      version          : 'v2.11'
    });
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "https://connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));

  //  $("#id_send_dialog").click(sendDialog);

  function sendDialog() {
    FB.ui({
      method: 'send',
      link: window.location.href
    });
  }

function copyURL() {
  var copyText = document.getElementById("id_share_url");
  copyText.select();
  document.execCommand("Copy");
  $("#id_url_text").html("Link has been copied!");
}

function markActivity(clicked_id) {
    var url_dest = '/activity/bookmark/'+clicked_id+'/';
    $.ajax({
        url: url_dest,
        type: 'get',
        dataType: 'json',
        beforeSend: function () {
            // alert(url_dest);
        },
        success: function(){
          $(this).toggleClass('active');
        }
    });
};

function sendReminder(clicked_id) {
  var url_dest = '/activity/'+clicked_id+'/reminder';
  $.ajax({
      url: url_dest,
      type: 'get',
      dataType: 'json',
      beforeSend: function () {
        $('#send-reminder').hide();
      },
      success: function(){
      }
  });
  $('#send-reminder').hide();
  $('#reminder-message').show();
};

// When user clicks the Back button, it will open the link to Update activity draft page
history.pushState(null, document.title, location.href);
window.addEventListener('popstate', function (event)
{
  // history.pushState(null, document.title, location.href); // preventing from pressing the back button
  var old_URL = document.referrer; // document.referrer = previous URL
  var edit_activity_URL = document.getElementById("edit_btn_url").getAttribute("href");
  var hostname = window.location.hostname;
  var dest_edit_url;

  if (hostname == 'localhost') {
    dest_edit_url = "http://" + hostname + ":8000" + edit_activity_URL;
  } else {
    dest_edit_url = "http://" + hostname + edit_activity_URL;
  }

  if ( old_URL == dest_edit_url ) { // Check if previous URL is editing the activity draft
    window.location.href = dest_edit_url;
    console.log("test");
  }
});

$(function() {
  $('.multiple-items').slick({
    infinite: true,
    slidesToShow: 3,
    slidesToScroll: 1,
    focusOnSelect: true,
    mobileFirst: true,
    responsive: [
    {
      breakpoint: 1024,
      settings: {
        slidesToShow: 3,
        slidesToScroll: 1,
        infinite: true
        // dots: true
      }
    },
    {
      breakpoint: 600,
      settings: {
        slidesToShow: 2,
        slidesToScroll: 1
      }
    },
    {
      breakpoint: 300,
      settings: {
        slidesToShow: 1,
        slidesToScroll: 1
      }
    }
    // You can unslick at a given breakpoint now by adding:
    // settings: "unslick"
    // instead of a settings object
    ],
    prevArrow: "<button type=\"button\" class=\"slick-prev\"><i class=\"fas fa-arrow-left\"></i></button>"
  });

  // Change apperance of bookmark button when clicked
  $( ".active" ).each(function() {
    $( this ).siblings('.remove').css( "display", "none" );
  });

  $('#edit_btn').tooltip();
  $('#send-reminder').tooltip();

  var isMobile = window.matchMedia("only screen and (max-width: 760px)");

  if (isMobile.matches) {
    $(".send_dialog").hide();
  }
  else{
    $("#share").hide();
    $("#share4").hide();
    $("#share5").hide();
  }

  $(".js-share-url").click(function () {
    $("#id_url_text").html("");
    $("#modal-share-url").modal("show");
  });

var loadForm = function () {
  var btn = $(this);
  $.ajax({
    url: btn.attr("data-url"),
    type: 'get',
    dataType: 'json',
    beforeSend: function () {
      $("#modal-register").modal("show");
    },
    success: function (data) {
      $("#modal-register .modal-content").html(data.html_form);
      console.log(data);
      if (data.fully_booked) {
        $("#modal-register").modal("hide");
        location.reload();
        // $("#modal-test").modal("show");
      }
    }
  });
};

var saveForm = function () {
  var form = $(this);
  $.ajax({
    url: form.attr("action"),
    data: form.serialize(),
    type: form.attr("method"),
    dataType: 'json',
    beforeSend: function () {
        $('.loading').show();
      },
    success: function (data) {
      $('.loading').hide();
      if (data.form_is_valid) {
        $("#contact-table").html(data.attendee_list);
        $("#attendees_no").html(data.attendees_no);
        $("#available_space").html(data.available_space);
        $("#modal-register").modal("hide");
      }
      else {
        $("#modal-register .modal-content").html(data.html_form);
      }
    }
  });
  return false;
};

// Add new attendee
$(".js-register-client").click(loadForm);
$("#modal-register").on("submit", ".js-booking-form", saveForm);

});
</script>

{% endblock %}
